ORG 00H           ; Início do programa

MOV P1, #0FFH     ; Inicializa display (desligado)
MOV P2, #00H      ; LEDs apagados
MOV R0, #0        ; Contador de moedas (inicia em 0)

LJMP MAIN
ORG 0100H

; Tabela de conversão para display de 7 segmentos (ânodo comum)
DISPLAY_TABLE:
    DB 0C0H, 0F9H, 0A4H, 0B0H, 099H, 092H, 082H, 0F8H, 080H, 090H

MAIN:
    ; Verifica botão de moeda (P3.0)
    JNB P3.0, INSERIR_MOEDA  
    ; Verifica botão de cancelar (P3.3)
    JNB P3.3, CANCELAR  
    ; Verifica se atingiu 3 moedas
    CJNE R0, #3, MAIN  
    ; Libera café (LED verde)
    SETB P2.1          ; Liga LED verde
    CLR P2.0           ; Desliga LED vermelho
    ; Espera um tempo (simula café sendo servido)
    CALL DELAY
    ; Reseta após servir
    MOV R0, #0
    CLR P2.1           ; Desliga LED verde
    SJMP MAIN

INSERIR_MOEDA:
    CALL DEBOUNCE      ; Evita leitura múltipla
    INC R0             ; Incrementa contador
    ; Mostra valor no display
    MOV A, R0
    MOV DPTR, #DISPLAY_TABLE
    MOVC A, @A+DPTR
    MOV P1, A
    ; Verifica se valor é suficiente
    CJNE R0, #3, AGUARDA_LIBERACAO
    SJMP MAIN

AGUARDA_LIBERACAO:
    ; Liga LED vermelho (valor insuficiente)
    SETB P2.0
    CLR P2.1
    SJMP MAIN

CANCELAR:
    CALL DEBOUNCE
    MOV R0, #0         ; Zera contador
    MOV P1, #0FFH      ; Apaga display
    CLR P2.0           ; Desliga LEDs
    CLR P2.1
    SJMP MAIN

DEBOUNCE:
    MOV R2, #50
DEBOUNCE_LOOP:
    CALL DELAY_SHORT
    DJNZ R2, DEBOUNCE_LOOP
    RET

DELAY:
    MOV R3, #100
DELAY_LOOP:
    CALL DELAY_SHORT
    DJNZ R3, DELAY_LOOP
    RET

DELAY_SHORT:
    MOV R4, #200
DELAY_SHORT_LOOP:
    DJNZ R4, DELAY_SHORT_LOOP
    RET

END
